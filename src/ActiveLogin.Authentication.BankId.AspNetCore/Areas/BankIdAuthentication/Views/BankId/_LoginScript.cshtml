@model ActiveLogin.Authentication.BankId.AspNetCore.Areas.BankIdAuthentication.Models.BankIdLoginViewModel

<script>
    (function (options) {
        // Elements

        var statusElement = document.querySelector('#bankIdLoginStatus');
        var statusSpinnerElement = statusElement.querySelector('.status-spinner');
        var statusMessageElement = statusElement.querySelector('.status-message');

        var formElement = document.querySelector('#bankIdLoginForm');
        var formFieldsetElement = formElement.querySelector('fieldset');
        var orderRefElement = formElement.querySelector('[name="OrderRef"]');
        var orderRef = orderRefElement.value;
        var autoLoginElement = formElement.querySelector('[name="AutoLogin"]');
        var autoLogin = autoLoginElement.value === 'true';

        var formSubmitButtonElement = formElement.querySelector('button[type="submit"]');
        var formSubmitButtonTextElement = null;
        var formSubmitButtonSpinnerElement = null;
        if (formSubmitButtonElement) {
            formSubmitButtonTextElement = formSubmitButtonElement.querySelector('.submit-text');
            formSubmitButtonSpinnerElement = formSubmitButtonElement.querySelector('.status-spinner');
        }

        // Events

        if (orderRef) {
            showOrderRefStatus(orderRef);
        } else if (autoLogin) {
            document.addEventListener('DOMContentLoaded', function() {
                login();
            });
        } else {
            formElement.addEventListener('submit', function (event) {
                event.preventDefault();

                login();
            });
        }

        // Boot

        function showOrderRefStatus(orderRef) {
            var requestVerificationTokenElement = formElement.querySelector('[name="RequestVerificationToken"]');
            var returnUrlElement = formElement.querySelector('[name="ReturnUrl"]');
            var loginOptionsElement = formElement.querySelector('[name="LoginOptions"]');

            hide(formElement);
            showStatus(options.initialStatusMessage, 'light', true);

            checkStatus(requestVerificationTokenElement.value, returnUrlElement.value, loginOptionsElement.value, orderRef);
        }

        function login() {
            var requestVerificationTokenElement = formElement.querySelector('[name="RequestVerificationToken"]');
            var returnUrlElement = formElement.querySelector('[name="ReturnUrl"]');
            var loginOptionsElement = formElement.querySelector('[name="LoginOptions"]');
            var personalIdentityNumberElement = formElement.querySelector('[name="PersonalIdentityNumber"]');
            var personalIdentityNumber = !!personalIdentityNumberElement ? personalIdentityNumberElement.value : '';

            initialize(requestVerificationTokenElement.value, returnUrlElement.value, loginOptionsElement.value, personalIdentityNumber, personalIdentityNumberElement);
        }

        // BankID

        function initialize(requestVerificationToken, returnUrl, loginOptions, personalIdentityNumber, personalIdentityNumberElement) {
            formFieldsetElement.disabled = true;
            show(formSubmitButtonSpinnerElement);
            hide(formSubmitButtonTextElement);
            postJson(options.bankIdInitializeApiUrl, requestVerificationToken, {
                'personalIdentityNumber': personalIdentityNumber,
                'returnUrl': returnUrl,
                'loginOptions': loginOptions
            })
                .then(function (data) {
                    if (data.isAutoLaunch) {
                        document.location = data.redirectUri;
                    } else if (!!data["PersonalIdentityNumber"]) {
                        setInvalidUntilChange(personalIdentityNumberElement);
                        formFieldsetElement.disabled = false;
                    } else {
                        hide(formElement);
                        showStatus(options.initialStatusMessage, 'light', true);
                        checkStatus(requestVerificationToken, returnUrl, loginOptions, data.orderRef);
                    }
                    show(formSubmitButtonTextElement);
                    hide(formSubmitButtonSpinnerElement);
                }).catch(function (error) {
                    showStatus(error.message, 'danger');
                    show(formSubmitButtonTextElement);
                    hide(formSubmitButtonSpinnerElement);
                    formFieldsetElement.disabled = false;
                });
        }

        function checkStatus(requestVerificationToken, returnUrl, loginOptions, orderRef) {
            postJson(options.bankIdStatusApiUrl, requestVerificationToken,
                {
                    'orderRef': orderRef,
                    'returnUrl': returnUrl,
                    'loginOptions': loginOptions
                })
                .then(function (data) {
                    if (data.isFinished) {
                        document.location = data.redirectUri;
                    } else {
                        showStatus(data.statusMessage, 'light', true);
                        setTimeout(function () {
                            checkStatus(requestVerificationToken, returnUrl, loginOptions, orderRef);
                        }, options.refreshIntervalMs);
                    }
                }).catch(function (error) {
                    showStatus(error.message, 'danger', false);
                });
        }

        // Helpers

        function postJson(url, requestVerificationToken, data) {
            return fetch(url,
                {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': requestVerificationToken
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                })
                .then(function (response) {
                    var contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    }

                    throw Error(options.unknownErrorMessage);
                })
                .then(function (data) {
                    if (!!data.errorMessage) {
                        throw Error(data.errorMessage);
                    }
                    return data;
                });
        }

        function showStatus(status, type, spinner) {
            var textClass = 'text-white';
            if (type === 'light') {
                textClass = '';
            }

            statusElement.className = 'card bg-' + type + ' ' + textClass;
            statusMessageElement.innerText = status;
            setVisibility(statusSpinnerElement, spinner, 'inline-block');
            show(statusElement);
        }

        function setVisibility(element, visible, display) {
            if (!!visible) {
                show(element, display);
            } else {
                hide(element, display);
            }
        }

        function show(element, display) {
            if (!element) {
                return;
            }

            element.style.display = display || 'block';
        }

        function hide(element) {
            if (!element) {
                return;
            }

            element.style.display = 'none';
        }

        function setInvalidUntilChange(element) {
            if (!element || !element.classList) {
                return;
            }

            element.classList.add('is-invalid');
            element.addEventListener('input', removeInvalid);

            function removeInvalid() {
                element.removeEventListener('input', removeInvalid);
                element.classList.remove('is-invalid');
            }
        }
    }(@Html.Raw(Model.LoginScriptOptionsJson)));
</script>