@model ActiveLogin.Authentication.BankId.AspNetCore.Areas.BankIdAuthentication.Models.BankIdLoginViewModel

<script>
    (function (options) {
        // Pre check
        var requiredFeatures = [window.fetch, window.sessionStorage];
        var isMissingSomeFeature = requiredFeatures.some(function(x) { return !x; });
        if (isMissingSomeFeature) {
            showStatus(options.unsupportedBrowserErrorMessage, 'danger', false, true);
            return;
        }

        // QR

        var qrLastRefreshTimestamp = null;
        var qrIsRefreshing = false;

        // OrderRef

        var sessionStorageOrderRefKey = 'ActiveLogin_BankId_OrderRef';
        var orderRef = sessionStorage.getItem(sessionStorageOrderRefKey);
        sessionStorage.removeItem(sessionStorageOrderRefKey);

        // Elements

        var formElement = document.querySelector('#bankIdLoginForm');

        var statusElement = document.querySelector('#bankIdLoginStatus');
        var statusWrapperElement = statusElement.querySelector('.status-wrapper');
        var statusSpinnerElement = statusElement.querySelector('.status-spinner');
        var statusMessageElement = statusElement.querySelector('.status-message');
        var cancelButtonElement = statusElement.querySelector('.btn-cancel');
        var qrCodeElement = statusElement.querySelector('.qr-code-image');

        var startBankIdAppButtonElement = document.querySelector('#bankIdLoginStartApp');
        
        // Events

        if (orderRef) {
            showOrderRefStatus(orderRef);
        } else {
            document.addEventListener('DOMContentLoaded', function () {
                resetUi();
                login();
            });
        }

        // Boot

        function showOrderRefStatus(orderRef) {
            var requestVerificationTokenElement = formElement.querySelector('[name="RequestVerificationToken"]');
            var returnUrlElement = formElement.querySelector('[name="ReturnUrl"]');
            var loginOptionsElement = formElement.querySelector('[name="LoginOptions"]');

            showStatus(options.initialStatusMessage, 'white', true);
            checkStatus(requestVerificationTokenElement.value, returnUrlElement.value, loginOptionsElement.value, orderRef);
        }

        function login() {
            var requestVerificationTokenElement = formElement.querySelector('[name="RequestVerificationToken"]');
            var returnUrlElement = formElement.querySelector('[name="ReturnUrl"]');
            var cancelReturnUrlElement = formElement.querySelector('[name="CancelReturnUrl"]');
            var loginOptionsElement = formElement.querySelector('[name="LoginOptions"]');

            initialize(requestVerificationTokenElement.value, returnUrlElement.value, cancelReturnUrlElement.value, loginOptionsElement.value);
        }

        function resetUi() {
            hide(qrCodeElement);
        }

        // BankID

        var autoStartAttempts = 0;
        var loginIsCancelledByUser = false;
        function initialize(requestVerificationToken, returnUrl, cancelUrl, loginOptions) {
            loginIsCancelledByUser = false;

            function enableCancelButton(orderRef) {
                var onCancelButtonClick = function(event) {
                    cancel(requestVerificationToken, cancelUrl, orderRef, loginOptions);
                    event.target.removeEventListener('click', onCancelButtonClick);
                };
                cancelButtonElement.addEventListener('click', onCancelButtonClick);
            }

            postJson(options.bankIdInitializeApiUrl, requestVerificationToken, {
                'returnUrl': returnUrl,
                'loginOptions': loginOptions
            })
                .then(function (data) {
                    if (data.isAutoLaunch) {
                        if (!data.checkStatus) {
                            sessionStorage.setItem(sessionStorageOrderRefKey, data.orderRef);
                        }

                        if (data.deviceMightRequireUserInteractionToLaunchBankIdApp) {
                            var startBankIdAppButtonOnClick = function(event) {
                                window.location.href = data.redirectUri;
                                hide(startBankIdAppButtonElement);
                                event.target.removeEventListener('click', startBankIdAppButtonOnClick);
                            };
                            startBankIdAppButtonElement.addEventListener('click', startBankIdAppButtonOnClick);

                            show(startBankIdAppButtonElement);
                        } else {
                            window.location.href = data.redirectUri;
                        }
                    }

                    if (!!data.qrStartState && !!data.qrCodeAsBase64) {
                        setQrCode(data.qrCodeAsBase64);
                        qrLastRefreshTimestamp = new Date();
                        refreshQrCode(requestVerificationToken, data.qrStartState);
                    }

                    enableCancelButton(data.orderRef);

                    hide(formElement);
                    showStatus(options.initialStatusMessage, 'white', true);

                    if (data.checkStatus) {
                        checkStatus(requestVerificationToken, returnUrl, loginOptions, data.orderRef);
                    }
                }).catch(function (error) {
                    showStatus(error.message, 'danger', false);
                    hide(qrCodeElement);
                    hide(startBankIdAppButtonElement);
                    enableCancelButton();
                });
        }

        function checkStatus(requestVerificationToken, returnUrl, loginOptions, orderRef) {
            if (loginIsCancelledByUser) {
                return;
            }

            postJson(options.bankIdStatusApiUrl, requestVerificationToken, {
                    'orderRef': orderRef,
                    'returnUrl': returnUrl,
                    'loginOptions': loginOptions,
                    'autoStartAttempts': autoStartAttempts
                })
                .then(function (data) {
                    if (data.retryLogin) {
                        autoStartAttempts++;
                        login();
                    } else if (data.isFinished) {
                        window.location.href = data.redirectUri;
                    } else if (!loginIsCancelledByUser) {
                        autoStartAttempts = 0;
                        showStatus(data.statusMessage, 'white', true);
                        setTimeout(function () {
                            checkStatus(requestVerificationToken, returnUrl, loginOptions, orderRef);
                        }, options.statusRefreshIntervalMs);
                    }
                }).catch(function (error) {
                    if (!loginIsCancelledByUser) {
                        showStatus(error.message, 'danger', false);
                        hide(startBankIdAppButtonElement);
                    }
                    hide(qrCodeElement);
                });
        }

        function refreshQrCode(requestVerificationToken, qrStartState) {
            if (loginIsCancelledByUser) {
                return;
            }

            if (qrIsRefreshing) {
                return;
            }

            var currentTime = new Date();
            var timeSinceLastRefresh = currentTime - qrLastRefreshTimestamp;
            if (timeSinceLastRefresh < options.qrCodeRefreshIntervalMs) {
                setTimeout(function () {
                    refreshQrCode(requestVerificationToken, qrStartState);
                }, options.qrCodeRefreshIntervalMs);
                return;
            }
            qrIsRefreshing = true;

            postJson(options.bankIdQrCodeApiUrl, requestVerificationToken, {
                    'qrStartState': qrStartState
                })
                .then(function (data) {
                    if (!!data.qrCodeAsBase64) {
                        qrLastRefreshTimestamp = new Date();
                        setQrCode(data.qrCodeAsBase64);
                        setTimeout(function () {
                            refreshQrCode(requestVerificationToken, qrStartState);
                        }, options.qrCodeRefreshIntervalMs);
                    }
                }).catch(function (error) {
                    if (!loginIsCancelledByUser) {
                        showStatus(error.message, 'danger', false);
                        hide(startBankIdAppButtonElement);
                    }
                    hide(qrCodeElement);
                }).finally(() => {
                    qrIsRefreshing = false;
                });
        }

        function setQrCode(qrCodeAsBase64) {
            qrCodeElement.src = 'data:image/png;base64, ' + qrCodeAsBase64;
            show(qrCodeElement);
        }

        function cancel(requestVerificationToken, cancelReturnUrl, orderRef, loginOptions) {
            loginIsCancelledByUser = true;

            if (!orderRef) {
                window.location.href = cancelReturnUrl;
                return;
            }

            postJson(options.bankIdCancelApiUrl,
                requestVerificationToken,
                {
                    'orderRef': orderRef,
                    'loginOptions': loginOptions
                }).finally(function() {
                    window.location.href = cancelReturnUrl;
                });
        }

        // Helpers

        function postJson(url, requestVerificationToken, data) {
            return fetch(url,
                {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': requestVerificationToken
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                })
                .then(function (response) {
                    var contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    }

                    throw Error(options.unknownErrorMessage);
                })
                .then(function (data) {
                    if (!!data.errorMessage) {
                        throw Error(data.errorMessage);
                    }
                    return data;
                });
        }

        function showStatus(status, type, spinner, html) {
            var textClass = 'text-white';
            if (type === 'white') {
                textClass = '';
            }

            statusWrapperElement.className = 'card status-wrapper bg-' + type + ' ' + textClass;
            if (!!html) {
                statusMessageElement.innerHTML = status;
            } else {
                statusMessageElement.innerText = status;
            }
            setVisibility(statusSpinnerElement, spinner, 'inline-block');
            show(statusElement);
        }

        function setVisibility(element, visible, display) {
            if (!!visible) {
                show(element, display);
            } else {
                hide(element, display);
            }
        }

        function show(element, display) {
            if (!element) {
                return;
            }

            element.style.display = display || 'block';
        }

        function hide(element) {
            if (!element) {
                return;
            }

            element.style.display = 'none';
        }
    }(@Html.Raw(Model.LoginScriptOptionsJson)));
</script>
